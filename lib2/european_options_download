import datetime as dt
import requests, pandas as pd

DERIBIT = "https://www.deribit.com/api/v2"

def download_deribit_options(underlying="BTC", timeout=30):
    """
    Download the **current** Deribit option book summary snapshot for `underlying`.
    Returns a DataFrame with all fields from Deribit plus:
      - run_date : UTC date when this function was executed
    Note: The API's per-row `creation_timestamp` is the actual snapshot time.
    """
    resp = requests.get(
        f"{DERIBIT}/public/get_book_summary_by_currency",
        params={"currency": underlying.upper(), "kind": "option"},
        timeout=timeout,
    )
    resp.raise_for_status()
    data = resp.json().get("result", [])
    if not data:
        raise RuntimeError("Empty snapshot from Deribit.")

    df = pd.DataFrame(data)
    df["run_date"] = dt.datetime.utcnow().date()
    return df

df = download_deribit_options(
    underlying="BTC"
)
df.head()

fname = f"./BTC_E_Options_09NOV25.csv"
df.to_csv(fname, index=False)
print(f"Saved {fname}")
